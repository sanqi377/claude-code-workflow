# CLAUDE 代理工作流系统

## 🚀 概述

CLAUDE 代理系统是一个为 **ArtisansChronicle iOS 项目** 实现功能和修复问题的结构化工作流。它使用 6 个专业代理按顺序工作，确保高质量的代码、适当的文档和安全的版本控制。规划代理需要指定哪些阶段可以同时进行！

## 🤖 代理

### 1. 规划代理 - 策略师

- **角色**: 调查问题并设计解决方案
- **分析**: 根本原因，而非症状
- **创建**: 为其他代理制定详细阶段
- **命令**: `/planner "描述你的问题或想法"`

### 2. 执行代理 - 建设者

- **角色**: 实现解决方案
- **遵循**: 来自规划代理的阶段 1 指令
- **使用**: 项目中既定的模式 (例如 `Utils/DesignSystem.swift`)
- **输出**: 干净、可运行的 Swift 代码

### 3. 验证代理 - 守护者

- **角色**: 确保代码质量
- **检查**: `CLAUDE.md` 合规性
- **运行**: 运行 `swiftlint` 等验证命令
- **输出**: 通过/失败报告

### 4. 测试代理 - 验证者

- **角色**: 测试功能
- **验证**: 用户流程和边缘情况
- **测试**: 在不同设备和 iOS 版本上
- **输出**: 测试结果

### 5. 文档代理 - 史学家

- **角色**: 更新文档
- **更新**: `CLAUDE.md` 新模式
- **维护**: `README.md` 或其他项目文档
- **输出**: 更新的文档

### 6. 更新代理 - 部署者

- **角色**: 处理版本控制
- **创建**: 详细的提交消息
- **推送**: 仅到 `develop` 分支
- **输出**: 提交确认

## 📋 工作原理

### 步骤 1：识别问题

用户报告问题或提议功能：

```bash
/planner "用户在主屏幕上刷新数据后，UI没有立即更新"
```

### 步骤 2：规划代理调查

规划代理分析：

- 当前的 SwiftUI 视图和 ViewModel 实现
- `Utils/` 目录中的辅助工具和模式
- 最近的构建和测试报告 (`XCTest` 结果)
- `ArtisansChronicle.xcdatamodeld` 中的数据模型
- `CLAUDE.md` 中记录的模式

输出：5 个阶段，每个代理都有具体指令

### 步骤 3：顺序执行

每个代理读取其阶段并执行：

```bash
/executer # 基于阶段 1 实现修复
/verifier # 基于阶段 2 验证代码质量
/tester # 基于阶段 3 测试功能
/documenter # 基于阶段 4 更新文档
/updater # 基于阶段5 提交更改
```

### 步骤 4：安全部署
- 更改提交到 `development` 分支
- 提示用户创建到 `main` 分支的 PR
- 不自动合并到生产环境

## 🎯 关键原则

### 1. 专注根本原因

- 不要修复症状，要修复实际问题
- 不要使用临时方案或快速补丁
- 遵循项目中既定的架构模式（如 MVVM）

### 2. 文档优先

- 实现前检查现有文档
- 实现后更新相关文档
- 保持 `CLAUDE.md` 最新

### 3. 质量门控

- 每个代理必须成功完成
- 验证必须通过（包括 `swiftlint` 检查）
- 测试必须通过 (`XCTest`)
- 文档必须更新
- 没有未被 `#if DEBUG` 包裹的 `print()` 语句
- 避免使用 `!` 强制解包可选类型
- 没有硬编码的用户界面文本（必须使用 `Localizable.strings`）
- 所有错误处理必须使用 `Logger` (OSLog)

### 4. 安全第一

- 永远不要直接推送到 `main` 分支
- 始终在 `develop` 或功能分支上工作
- 生产环境的部署需要手动批准和 Code Review

## 💡 示例工作流

### 问题："UI 在后台获取数据后未更新"

**规划代理输出：**

```
根本原因：ViewModel 中的数据更新未在主线程上发布，导致 SwiftUI 视图无法刷新。
解决方案：使用 @MainActor 或 DispatchQueue.main.async 将 UI 更新操作调度到主线程。
阶段 1 - 执行代理：
- 在 HomeViewModel.swift 中，将更新 @Published 属性的网络请求回调包裹在 Task 中，并确保 ViewModel 标记为 @MainActor。
- 模式参考：`docs/architecture/MVVM.md`
阶段 2 - 验证代理：
- 运行 `swiftlint` 检查代码风格。
- 确保没有引入强制解包 (`!`)。
阶段 3 - 测试代理：
- 在真实设备和模拟器上测试数据刷新流程。
- 使用 Xcode 的网络链接调节器测试慢速网络下的情况。
阶段 4 - 文档代理：
- 如果引入了新的异步处理模式，向 LEARNINGS.md 添加说明。
阶段 5 - 更新代理：
- 提交为 `fix(Home): 确保后台数据同步后UI能正确更新`
```

**结果**：问题被系统性地解决并记录在案。

## 📝 最佳实践

### 对用户

1. 清楚地描述问题或功能需求。
2. 如果可能，包含截图或重现步骤。
3. 等待每个代理完成其任务。
4. 在合并到主分支前审查代码更改。

### 对开发

1. 始终从规划代理开始。
2. 永远不要跳过任何一个代理。
3. 在继续下一步之前修复失败的阶段。
4. 记录所有重要的架构决策。

## 🚫 常见错误

1. **跳过规划代理**：直接开始编码。
2. **忽略验证代理**：推送未通过 `swiftlint` 检查的代码。
3. **跳过文档代理**：不更新文档。
4. **直接推送到 main**：未经审查就合并代码。

## 📊 成功指标

- ✅ 所有验证通过
- ✅ 没有 Swift 编译警告或错误
- ✅ `swiftlint` 通过
- ✅ 所有单元测试和 UI 测试 (`XCTest`) 通过
- ✅ 文档已更新
- ✅ 干净的 Git 提交历史
- ✅ 安全的部署过程

## 🛠 使用工具

- **Xcode**: 主要 IDE
- **Swift & SwiftUI**: 核心开发语言和 UI 框架
- **Swift Package Manager (SPM)**: 依赖管理
- **SwiftLint**: 代码质量和风格检查
- **Git**: 版本控制
- **XCTest**: 单元测试和 UI 测试

## 🔄 持续改进

系统从每个问题中学习：

1. 新模式 → `CLAUDE.md`
2. 新解决方案 → docs/
3. 新的反模式 → 记录并避免
4. 更好的工作流 → 代理流程更新

---

## 快速开始

1. 安装 Claude.ai 桌面应用。
2. 启用 Claude Code 功能。
3. 在 Claude 中打开项目目录。
4. 使用 `/planner "你的问题"` 开始。
5. 遵循代理序列完成工作。
6. 安全地构建和部署你的应用。

记住：**质量胜过速度。第一次就把它做对。**